{% extends 'process/process_layout.html' %}

{% block process_content %}
<style>
.settings-tabs {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 24px;
    overflow-x: auto;
}

.settings-tab {
    padding: 12px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
}

.settings-tab:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.settings-tab.active {
    color: var(--accent-blue);
    border-bottom-color: var(--accent-blue);
}

.settings-tab-content {
    display: none;
}

.settings-tab-content.active {
    display: block;
}

.env-var-row {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    align-items: center;
}

.env-var-row input {
    flex: 1;
}

.env-var-row button {
    flex-shrink: 0;
}

.env-var-list {
    max-height: 400px;
    overflow-y: auto;
}
</style>

<div class="row gap-0">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> Process Settings
            </div>
            <div class="card-body">
                <!-- Settings Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="switchTab('general')">
                        <i class="bi bi-gear"></i> General
                    </button>
                    <button class="settings-tab" onclick="switchTab('environment')">
                        <i class="bi bi-code-square"></i> Environment Variables
                    </button>
                    <button class="settings-tab" onclick="switchTab('advanced')">
                        <i class="bi bi-sliders"></i> Advanced
                    </button>
                </div>

                <!-- General Tab -->
                <div id="tab-general" class="settings-tab-content active">
                <form method="POST" action="{{ url_for('process.settings', name=process.name) }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Container ID</label>
                            <input type="text" class="form-control" name="containerid" value="{{ process.id }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Process ID</label>
                            <input type="text" class="form-control" name="processid" value="{{ process.process_id }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Process Name</label>
                            <input type="text" class="form-control" name="name" value="{{ process.name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Port Number</label>
                            <input type="text" class="form-control" name="port" value="{{ 8000 + process.port_id }}" readonly>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3">{{ process.description }}</textarea>
                        </div>
                        <div class="row gap-0 col-12">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Command</label>
                                <input type="text" class="form-control" name="command" value="{{ process.command }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Process Type</label>
                                <select name="type" class="form-select">
                                    {% for type in types %}
                                    <option value="{{type}}" {% if process.type == type %} selected {% endif %}>{{type | capitalize}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </form>
                </div>

                <!-- Environment Variables Tab -->
                <div id="tab-environment" class="settings-tab-content">
                    <h5><i class="bi bi-list-ul"></i> Environment Variables</h5>
                    <p class="text-muted">Manage environment variables for this process</p>
                    
                    <div class="env-var-list" id="env-var-list">
                        <!-- Environment variables will be loaded here -->
                    </div>

                    <button class="btn btn-success mt-3" onclick="addEnvVar()">
                        <i class="bi bi-plus-circle"></i> Add Variable
                    </button>
                    <button class="btn btn-primary mt-3" onclick="saveEnvVars()">
                        <i class="bi bi-save"></i> Save Variables
                    </button>
                </div>

                <!-- Advanced Tab -->
                <div id="tab-advanced" class="settings-tab-content">
                    <h5><i class="bi bi-sliders"></i> Advanced Settings</h5>
                    <p class="text-muted">Advanced configuration options</p>

                    <div class="form-group">
                        <label>Restart Policy</label>
                        <select class="form-control">
                            <option>No restart</option>
                            <option selected>Always restart</option>
                            <option>On failure</option>
                        </select>
                    </div>

                    <div class="form-group mt-3">
                        <label>CPU Limit (%)</label>
                        <input type="number" class="form-control" value="100" min="1" max="100">
                    </div>

                    <div class="form-group mt-3">
                        <label>Memory Limit (MB)</label>
                        <input type="number" class="form-control" value="512" min="128">
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="auto-start">
                        <label class="form-check-label" for="auto-start">
                            Auto-start on server boot
                        </label>
                    </div>

                    <button class="btn btn-primary mt-3">
                        <i class="bi bi-save"></i> Save Advanced Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4">
        <div class="card">
            <div class="card-header bg-warning">
                <i class="bi bi-tools"></i> Process Actions
            </div>
            <div class="card-body">
                <h6>Rebuild Process</h6>
                <p class="text-muted small">Rebuild the process container with current settings.</p>
                <form method="POST" action="{{ url_for('process.settings_rebuild', name=process.name) }}">
                    <button type="submit" class="btn btn-warning w-100 mb-3">
                        <i class="bi bi-arrow-clockwise"></i> Rebuild Process
                    </button>
                </form>

                <h6>Delete Process</h6>
                <p class="text-muted small">Permanently remove this process and all its data.</p>
                <form method="POST" action="{{ url_for('process.settings_delete', name=process.name) }}">
                    <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Are you sure you want to delete this process?')">
                        <i class="bi bi-trash"></i> Delete Process
                    </button>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-info">
                <i class="bi bi-info-circle"></i> Process Information
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <small class="text-muted">Created:</small>
                        <div class="fw-bold">{{ process.created_at.strftime('%Y-%m-%d') if process.created_at else 'Unknown' }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Status:</small>
                        <div class="fw-bold">
                            {% if process.status == 'running' %}
                            <span class="badge bg-success">Running</span>
                            {% else %}
                            <span class="badge bg-secondary">Stopped</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let envVars = [];

function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.settings-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');

    // Load environment variables if switching to that tab
    if (tabName === 'environment') {
        loadEnvVars();
    }
}

function loadEnvVars() {
    // TODO: Load from backend
    // For now, using sample data
    envVars = [
        { key: 'NODE_ENV', value: 'production' },
        { key: 'PORT', value: '3000' },
        { key: 'DATABASE_URL', value: 'postgresql://localhost:5432/mydb' }
    ];
    renderEnvVars();
}

function renderEnvVars() {
    const list = document.getElementById('env-var-list');
    list.innerHTML = envVars.map((env, index) => `
        <div class="env-var-row">
            <input 
                type="text" 
                class="form-control" 
                placeholder="Key" 
                value="${env.key}"
                onchange="updateEnvVar(${index}, 'key', this.value)"
            >
            <input 
                type="text" 
                class="form-control" 
                placeholder="Value" 
                value="${env.value}"
                onchange="updateEnvVar(${index}, 'value', this.value)"
            >
            <button class="btn btn-danger btn-sm" onclick="removeEnvVar(${index})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `).join('');
}

function addEnvVar() {
    envVars.push({ key: '', value: '' });
    renderEnvVars();
    showInfo('New environment variable added');
}

function updateEnvVar(index, field, value) {
    envVars[index][field] = value;
}

function removeEnvVar(index) {
    if (confirm('Remove this environment variable?')) {
        envVars.splice(index, 1);
        renderEnvVars();
        showSuccess('Environment variable removed');
    }
}

async function saveEnvVars() {
    // Validate
    const invalid = envVars.filter(env => !env.key.trim());
    if (invalid.length > 0) {
        showWarning('Please fill in all environment variable keys');
        return;
    }

    try {
        const response = await fetch('{{ url_for("process.save_env_vars", name=process.name) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ env_vars: envVars })
        });

        const data = await response.json();

        if (data.success) {
            showSuccess(data.message || 'Environment variables saved successfully');
        } else {
            showError(data.error || 'Failed to save environment variables');
        }
    } catch (error) {
        showError('Error saving environment variables: ' + error.message);
        console.error('Error:', error);
    }
}
</script>

{% endblock process_content %}
