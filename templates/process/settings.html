{% extends 'process/process_layout.html' %}

{% block process_content %}
<style>
.settings-tabs {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 24px;
    overflow-x: auto;
}

.settings-tab {
    padding: 12px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
}

.settings-tab:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.settings-tab.active {
    color: var(--accent-blue);
    border-bottom-color: var(--accent-blue);
}

.settings-tab-content {
    display: none;
}

.settings-tab-content.active {
    display: block;
}

.env-var-row {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    align-items: center;
}

.env-var-row input {
    flex: 1;
}

.env-var-row button {
    flex-shrink: 0;
}

.env-var-list {
    max-height: 400px;
    overflow-y: auto;
}

/* Domain Status Styles */
#domain-feedback .alert {
    margin-bottom: 0.75rem;
    padding: 1rem 1.25rem;
    font-size: 0.95rem;
    border: none;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

#domain-feedback .alert::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
}

#domain-feedback .alert.alert-success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
}

#domain-feedback .alert.alert-success::before {
    background: linear-gradient(135deg, #28a745, #20c997);
}

#domain-feedback .alert.alert-danger {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
}

#domain-feedback .alert.alert-danger::before {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
}

#domain-feedback .alert.alert-warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
}

#domain-feedback .alert.alert-warning::before {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
}

#domain-feedback .alert.alert-info {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    color: #0c5460;
}

#domain-feedback .alert.alert-info::before {
    background: linear-gradient(135deg, #17a2b8, #6f42c1);
}

#domain-feedback .alert:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

#domain-feedback .alert i {
    margin-right: 0.5rem;
    font-size: 1.1em;
}

.domain-status-details {
    font-size: 0.9rem;
}

.status-section {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.status-section:last-child {
    border-bottom: none;
}

.status-section h6 {
    font-size: 1rem;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.status-section div {
    margin-bottom: 0.25rem;
    color: var(--text-secondary);
}

#domain-status-card {
    transition: all 0.3s ease;
}

#domain-input.is-invalid {
    border-color: #dc3545;
}

#domain-input.is-valid {
    border-color: #28a745;
}
</style>

<div class="row gap-0">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> Process Settings
            </div>
            <div class="card-body">
                <!-- Settings Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="switchTab('general')">
                        <i class="bi bi-gear"></i> General
                    </button>
                    <button class="settings-tab" onclick="switchTab('environment')">
                        <i class="bi bi-code-square"></i> Environment Variables
                    </button>
                    <button class="settings-tab" onclick="switchTab('advanced')">
                        <i class="bi bi-sliders"></i> Advanced
                    </button>
                </div>

                <!-- General Tab -->
                <div id="tab-general" class="settings-tab-content active">
                <form method="POST" action="{{ url_for('process.settings', name=process.name) }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Container ID</label>
                            <input type="text" class="form-control" name="containerid" value="{{ process.id }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Process ID</label>
                            <input type="text" class="form-control" name="processid" value="{{ process.process_id }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Process Name</label>
                            <input type="text" class="form-control" name="name" value="{{ process.name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Port Number</label>
                            <input type="text" class="form-control" name="port" value="{{ 8000 + process.port_id }}" readonly>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3">{{ process.description }}</textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Domain Name</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="domain" id="domain-input" value="{{ process.domain or '' }}" placeholder="example.com or *.example.com">
                                <button class="btn btn-outline-primary" type="button" id="validate-domain-btn" onclick="validateDomain()">
                                    <i class="bi bi-check-circle"></i> Validate
                                </button>
                            </div>
                            <div id="domain-feedback" class="mt-2"></div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Enter your domain for Nginx configuration and SSL certificates. Supports wildcards (*.domain.com).
                            </small>
                        </div>
                        <div class="row gap-0 col-12">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Command</label>
                                <input type="text" class="form-control" name="command" value="{{ process.command }}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Process Type</label>
                                <select name="type" class="form-select">
                                    {% for type in types %}
                                    <option value="{{type}}" {% if process.type == type %} selected {% endif %}>{{type | capitalize}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </form>
                </div>

                <!-- Environment Variables Tab -->
                <div id="tab-environment" class="settings-tab-content">
                    <h5><i class="bi bi-list-ul"></i> Environment Variables</h5>
                    <p class="text-muted">Manage environment variables for this process</p>
                    
                    <div class="env-var-list" id="env-var-list">
                        <!-- Environment variables will be loaded here -->
                    </div>

                    <button class="btn btn-success mt-3" onclick="addEnvVar()">
                        <i class="bi bi-plus-circle"></i> Add Variable
                    </button>
                    <button class="btn btn-primary mt-3" onclick="saveEnvVars()">
                        <i class="bi bi-save"></i> Save Variables
                    </button>
                </div>

                <!-- Advanced Tab -->
                <div id="tab-advanced" class="settings-tab-content">
                    <h5><i class="bi bi-sliders"></i> Advanced Settings</h5>
                    <p class="text-muted">Advanced configuration options</p>

                    <div class="form-group">
                        <label>Restart Policy</label>
                        <select class="form-control">
                            <option>No restart</option>
                            <option selected>Always restart</option>
                            <option>On failure</option>
                        </select>
                    </div>

                    <div class="form-group mt-3">
                        <label>CPU Limit (%)</label>
                        <input type="number" class="form-control" value="100" min="1" max="100">
                    </div>

                    <div class="form-group mt-3">
                        <label>Memory Limit (MB)</label>
                        <input type="number" class="form-control" value="512" min="128">
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="auto-start">
                        <label class="form-check-label" for="auto-start">
                            Auto-start on server boot
                        </label>
                    </div>

                    <button class="btn btn-primary mt-3">
                        <i class="bi bi-save"></i> Save Advanced Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4">
        <div class="card">
            <div class="card-header bg-warning">
                <i class="bi bi-tools"></i> Process Actions
            </div>
            <div class="card-body">
                <h6>Rebuild Process</h6>
                <p class="text-muted small">Rebuild the process container with current settings.</p>
                <form method="POST" action="{{ url_for('process.settings_rebuild', name=process.name) }}">
                    <button type="submit" class="btn btn-warning w-100 mb-3">
                        <i class="bi bi-arrow-clockwise"></i> Rebuild Process
                    </button>
                </form>

                <h6>Delete Process</h6>
                <p class="text-muted small">Permanently remove this process and all its data.</p>
                <form method="POST" action="{{ url_for('process.settings_delete', name=process.name) }}">
                    <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Are you sure you want to delete this process?')">
                        <i class="bi bi-trash"></i> Delete Process
                    </button>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-info">
                <i class="bi bi-info-circle"></i> Process Information
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-6">
                        <small class="text-muted">Created:</small>
                        <div class="fw-bold">{{ process.created_at.strftime('%Y-%m-%d') if process.created_at else 'Unknown' }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Status:</small>
                        <div class="fw-bold">
                            {% if process.status == 'running' %}
                            <span class="badge bg-success">Running</span>
                            {% else %}
                            <span class="badge bg-secondary">Stopped</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-cloud"></i> Cloudflare DNS
                </div>
                {% if cloudflare_configured %}
                <span class="badge bg-success">Token configured</span>
                {% else %}
                <a href="{{ url_for('settings.preferences_page') }}" class="badge bg-warning text-dark">Add API token in Settings</a>
                {% endif %}
            </div>
            <div class="card-body">
                <p class="text-muted small">
                    Create or delete a DNS record for this process using your stored Cloudflare API token.
                    {% if server_ip %}Default A record value uses this server IP: <strong>{{ server_ip }}</strong>.{% endif %}
                </p>

                <div id="cloudflare-data" data-configured="{{ 'true' if cloudflare_configured else 'false' }}" data-server-ip="{{ server_ip or '' }}"></div>

                <div id="cloudflare-alert" style="display:none;"></div>

                <div class="mb-3">
                    <label class="form-label">Record Type</label>
                    <select class="form-select" id="cloudflare-record-type" {% if not cloudflare_configured %}disabled{% endif %}>
                        <option value="A" selected>A</option>
                        <option value="CNAME">CNAME</option>
                        <option value="AAAA">AAAA</option>
                        <option value="TXT">TXT</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Record Name</label>
                    <input type="text" class="form-control" id="cloudflare-record-name" value="{{ process.domain or '' }}" placeholder="example.com" {% if not cloudflare_configured %}disabled{% endif %}>
                    <small class="text-muted">Uses the process domain by default. Wildcards will be trimmed to the root.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Record Value</label>
                    <input type="text" class="form-control" id="cloudflare-record-value" placeholder="{{ server_ip or 'e.g., 203.0.113.10' }}" {% if not cloudflare_configured %}disabled{% endif %}>
                    <small class="text-muted">For A records, leave blank to use the server IP.</small>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="cloudflare-proxied" {% if not cloudflare_configured %}disabled{% endif %} checked>
                    <label class="form-check-label" for="cloudflare-proxied">Proxied (orange cloud)</label>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="cloudflare-create-btn" onclick="submitCloudflareRecord('create')" {% if not cloudflare_configured %}disabled{% endif %}>
                        <i class="bi bi-plus-circle"></i> Create / Upsert
                    </button>
                    <button class="btn btn-outline-danger" id="cloudflare-delete-btn" onclick="submitCloudflareRecord('delete')" {% if not cloudflare_configured %}disabled{% endif %}>
                        <i class="bi bi-trash"></i> Delete Record
                    </button>
                </div>
            </div>
        </div>

        <div class="card mt-3" id="domain-status-card" style="display: none;">
            <div class="card-header" id="domain-status-header">
                <i class="bi bi-globe"></i> Domain Status
            </div>
            <div class="card-body">
                <div id="domain-status-content">
                    <!-- Domain status will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let envVars = [];

function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.settings-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');

    // Load environment variables if switching to that tab
    if (tabName === 'environment') {
        loadEnvVars();
    }
}

function loadEnvVars() {
    // TODO: Load from backend
    // For now, using sample data
    envVars = [
        { key: 'NODE_ENV', value: 'production' },
        { key: 'PORT', value: '3000' },
        { key: 'DATABASE_URL', value: 'postgresql://localhost:5432/mydb' }
    ];
    renderEnvVars();
}

function renderEnvVars() {
    const list = document.getElementById('env-var-list');
    list.innerHTML = envVars.map((env, index) => `
        <div class="env-var-row">
            <input 
                type="text" 
                class="form-control" 
                placeholder="Key" 
                value="${env.key}"
                onchange="updateEnvVar(${index}, 'key', this.value)"
            >
            <input 
                type="text" 
                class="form-control" 
                placeholder="Value" 
                value="${env.value}"
                onchange="updateEnvVar(${index}, 'value', this.value)"
            >
            <button class="btn btn-danger btn-sm" onclick="removeEnvVar(${index})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `).join('');
}

function addEnvVar() {
    envVars.push({ key: '', value: '' });
    renderEnvVars();
    showInfo('New environment variable added');
}

function updateEnvVar(index, field, value) {
    envVars[index][field] = value;
}

function removeEnvVar(index) {
    if (confirm('Remove this environment variable?')) {
        envVars.splice(index, 1);
        renderEnvVars();
        showSuccess('Environment variable removed');
    }
}

async function saveEnvVars() {
    // Validate
    const invalid = envVars.filter(env => !env.key.trim());
    if (invalid.length > 0) {
        showWarning('Please fill in all environment variable keys');
        return;
    }

    try {
        const response = await fetch('{{ url_for("process.save_env_vars", name=process.name) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ env_vars: envVars })
        });

        const data = await response.json();

        if (data.success) {
            showSuccess(data.message || 'Environment variables saved successfully');
        } else {
            showError(data.error || 'Failed to save environment variables');
        }
    } catch (error) {
        showError('Error saving environment variables: ' + error.message);
        console.error('Error:', error);
    }
}

// ==================== Cloudflare DNS ====================

const cfDataEl = document.getElementById('cloudflare-data');
const cloudflareConfigured = cfDataEl?.dataset.configured === 'true';
const cloudflareServerIp = cfDataEl?.dataset.serverIp || '';

function setCloudflarePlaceholder() {
    const typeSelect = document.getElementById('cloudflare-record-type');
    const valueInput = document.getElementById('cloudflare-record-value');
    if (!typeSelect || !valueInput) return;

    const type = typeSelect.value;
    if (type === 'A') {
        valueInput.placeholder = cloudflareServerIp || 'Server public IPv4 (e.g., 203.0.113.10)';
    } else if (type === 'CNAME') {
        valueInput.placeholder = 'target.example.com';
    } else if (type === 'AAAA') {
        valueInput.placeholder = '2001:db8::1';
    } else {
        valueInput.placeholder = 'Value';
    }
}

async function submitCloudflareRecord(action) {
    const alertBox = document.getElementById('cloudflare-alert');
    const type = document.getElementById('cloudflare-record-type').value;
    const name = document.getElementById('cloudflare-record-name').value.trim();
    const value = document.getElementById('cloudflare-record-value').value.trim();
    const proxied = document.getElementById('cloudflare-proxied').checked;

    if (!cloudflareConfigured) {
        showCloudflareAlert('warning', 'Configure your Cloudflare API token in Settings first.');
        return;
    }

    if (!name) {
        showCloudflareAlert('warning', 'Record name is required.');
        return;
    }

    if (action === 'create' && type !== 'A' && !value) {
        showCloudflareAlert('warning', 'Record value is required for this record type.');
        return;
    }

    const endpoint = action === 'delete'
        ? '{{ url_for("process.cloudflare_delete", name=process.name) }}'
        : '{{ url_for("process.cloudflare_create", name=process.name) }}';

    const button = action === 'delete' ? document.getElementById('cloudflare-delete-btn') : document.getElementById('cloudflare-create-btn');
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + (action === 'delete' ? 'Deleting...' : 'Creating...');

    try {
        const resp = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ type, name, value, proxied })
        });

        const data = await resp.json();
        if (data.success) {
            showCloudflareAlert('success', data.message || 'Success');
            if (action === 'create' && !value && type === 'A') {
                document.getElementById('cloudflare-record-value').value = cloudflareServerIp;
            }
        } else {
            showCloudflareAlert('danger', data.error || 'Request failed.');
        }
    } catch (err) {
        showCloudflareAlert('danger', `Error: ${err.message}`);
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

function showCloudflareAlert(level, message) {
    const alertBox = document.getElementById('cloudflare-alert');
    alertBox.className = `alert alert-${level}`;
    alertBox.innerHTML = `<i class="bi bi-info-circle"></i> ${message}`;
    alertBox.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', () => {
    const typeSelect = document.getElementById('cloudflare-record-type');
    if (typeSelect) {
        typeSelect.addEventListener('change', setCloudflarePlaceholder);
        setCloudflarePlaceholder();
    }
});

// ==================== Domain Validation Functions ====================

async function validateDomain() {
    const domainInput = document.getElementById('domain-input');
    const domain = domainInput.value.trim();
    const feedbackDiv = document.getElementById('domain-feedback');
    const validateBtn = document.getElementById('validate-domain-btn');
    
    if (!domain) {
        feedbackDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Please enter a domain name</div>';
        document.getElementById('domain-status-card').style.display = 'none';
        return;
    }
    
    // Show loading state
    validateBtn.disabled = true;
    validateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Validating...';
    feedbackDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Validating domain...</div>';
    
    try {
        const response = await fetch('{{ url_for("process.validate_domain", name=process.name) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ domain: domain })
        });
        
        const data = await response.json();
        
        // Display validation feedback
        displayDomainFeedback(data);
        displayDomainStatus(data);
        
    } catch (error) {
        feedbackDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Error: ${error.message}</div>`;
    } finally {
        validateBtn.disabled = false;
        validateBtn.innerHTML = '<i class="bi bi-check-circle"></i> Validate';
    }
}

function displayDomainFeedback(data) {
    const feedbackDiv = document.getElementById('domain-feedback');
    let html = '';
    
    // Validation status
    if (data.validation && !data.validation.valid) {
        html += `<div class="alert alert-danger">
            <i class="bi bi-x-circle"></i> <strong>Invalid Domain:</strong> ${data.validation.error}
        </div>`;
        feedbackDiv.innerHTML = html;
        return;
    }
    
    // Uniqueness check
    if (data.uniqueness && !data.uniqueness.unique) {
        html += `<div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> <strong>Domain Conflict:</strong> 
            This domain is already used by: ${data.uniqueness.conflicts.join(', ')}
        </div>`;
    }
    
    // DNS status
    if (data.dns) {
        if (data.dns.status === 'error') {
            html += `<div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> <strong>DNS Error:</strong> ${data.dns.errors.join(', ')}
            </div>`;
        } else if (data.dns.status === 'warning') {
            html += `<div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> <strong>DNS Warning:</strong> ${data.dns.warnings.join(', ')}
            </div>`;
        } else if (data.dns.status === 'healthy') {
            html += `<div class="alert alert-success">
                <i class="bi bi-check-circle"></i> <strong>DNS Healthy:</strong> Domain correctly points to this server
            </div>`;
        }
    }
    
    // SSL status
    if (data.ssl) {
        if (!data.ssl.exists) {
            html += `<div class="alert alert-info">
                <i class="bi bi-shield-exclamation"></i> <strong>No SSL Certificate:</strong> You can create one from the Nginx tab
            </div>`;
        } else if (!data.ssl.valid) {
            html += `<div class="alert alert-danger">
                <i class="bi bi-shield-x"></i> <strong>SSL Certificate Expired:</strong> ${data.ssl.errors.join(', ')}
            </div>`;
        } else if (data.ssl.warning) {
            html += `<div class="alert alert-warning">
                <i class="bi bi-shield-exclamation"></i> <strong>SSL Warning:</strong> ${data.ssl.warning}
            </div>`;
        } else {
            html += `<div class="alert alert-success">
                <i class="bi bi-shield-check"></i> <strong>SSL Valid:</strong> Certificate expires in ${data.ssl.days_until_expiry} days
            </div>`;
        }
    }
    
    if (!html) {
        html = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Domain validation passed</div>';
    }
    
    feedbackDiv.innerHTML = html;
}

function displayDomainStatus(data) {
    const statusCard = document.getElementById('domain-status-card');
    const statusHeader = document.getElementById('domain-status-header');
    const statusContent = document.getElementById('domain-status-content');
    
    if (!data.validation || !data.validation.valid) {
        statusCard.style.display = 'none';
        return;
    }
    
    // Update header based on overall status
    const statusIcons = {
        'healthy': { icon: 'check-circle', class: 'bg-success', text: 'Healthy' },
        'no_ssl': { icon: 'shield-exclamation', class: 'bg-info', text: 'No SSL' },
        'ssl_expired': { icon: 'shield-x', class: 'bg-danger', text: 'SSL Expired' },
        'dns_warning': { icon: 'exclamation-triangle', class: 'bg-warning', text: 'DNS Issue' },
        'dns_error': { icon: 'x-circle', class: 'bg-danger', text: 'DNS Error' },
        'conflict': { icon: 'exclamation-triangle', class: 'bg-warning', text: 'Domain Conflict' },
        'needs_configuration': { icon: 'gear', class: 'bg-secondary', text: 'Needs Configuration' }
    };
    
    const status = statusIcons[data.overall_status] || statusIcons['needs_configuration'];
    statusHeader.className = `card-header ${status.class}`;
    statusHeader.innerHTML = `<i class="bi bi-${status.icon}"></i> Domain Status: ${status.text}`;
    
    // Build detailed status content
    let html = `<div class="domain-status-details">`;
    
    // DNS Information
    if (data.dns && data.dns.records) {
        html += `<div class="status-section">
            <h6><i class="bi bi-dns"></i> DNS Records</h6>`;
        
        if (data.dns.records.A && data.dns.records.A.length > 0) {
            html += `<div><strong>A Records:</strong> ${data.dns.records.A.join(', ')}</div>`;
        }
        if (data.dns.records.AAAA && data.dns.records.AAAA.length > 0) {
            html += `<div><strong>AAAA Records:</strong> ${data.dns.records.AAAA.join(', ')}</div>`;
        }
        if (data.dns.records.CNAME && data.dns.records.CNAME.length > 0) {
            html += `<div><strong>CNAME Records:</strong> ${data.dns.records.CNAME.join(', ')}</div>`;
        }
        html += `<div class="mt-2"><small class="text-muted">Server IP: ${data.dns.server_ip || 'Unknown'}</small></div>`;
        html += `</div>`;
    }
    
    // SSL Information
    if (data.ssl && data.ssl.exists) {
        html += `<div class="status-section mt-3">
            <h6><i class="bi bi-shield-check"></i> SSL Certificate</h6>`;
        
        if (data.ssl.issuer_name) {
            html += `<div><strong>Issuer:</strong> ${data.ssl.issuer_name}</div>`;
        }
        if (data.ssl.validation_type) {
            html += `<div><strong>Type:</strong> ${data.ssl.validation_type}</div>`;
        }
        if (data.ssl.issued_date) {
            html += `<div><strong>Issued:</strong> ${data.ssl.issued_date}</div>`;
        }
        if (data.ssl.expiration_date) {
            html += `<div><strong>Expires:</strong> ${data.ssl.expiration_date}</div>`;
        }
        if (data.ssl.days_until_expiry !== undefined) {
            const daysClass = data.ssl.days_until_expiry > 30 ? 'text-success' : (data.ssl.days_until_expiry > 0 ? 'text-warning' : 'text-danger');
            html += `<div><strong>Days Until Expiry:</strong> <span class="${daysClass}">${data.ssl.days_until_expiry}</span></div>`;
        }
        if (data.ssl.is_wildcard) {
            html += `<div class="mt-2"><span class="badge bg-info"><i class="bi bi-asterisk"></i> Wildcard Certificate</span></div>`;
        }
        html += `</div>`;
    }
    
    html += `</div>`;
    
    statusContent.innerHTML = html;
    statusCard.style.display = 'block';
}

// Auto-validate on page load if domain exists
document.addEventListener('DOMContentLoaded', function() {
    const domainInput = document.getElementById('domain-input');
    if (domainInput && domainInput.value.trim()) {
        validateDomain();
    }
    
    // Add real-time validation on input
    domainInput.addEventListener('input', debounce(function() {
        if (domainInput.value.trim().length > 3) {
            validateDomain();
        }
    }, 1000));
});

// Debounce helper function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>

{% endblock process_content %}
