{% extends 'layout.html' %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary">
                <i class="bi bi-server"></i> Managed Processes
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" id="search-bar" class="form-control mb-2" placeholder="Search process..." oninput="filterProcesses()">
                    <select id="sort-select" class="form-select w-auto" onchange="sortProcesses()">
                        <option value="alpha">Alphabet (A-Z)</option>
                        <option value="alpha-reverse">Alphabet (Z-A)</option>
                        <option value="created">Created At (Oldest)</option>
                        <option value="created-reverse">Created At (Newest)</option>
                    </select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Process ID</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="process-grid"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-success">
                <i class="bi bi-cpu"></i> System Resources
            </div>
            <div class="card-body" id="server-stats">
                <div class="progress-item">
                    <div class="progress-header">
                        <span>CPU Usage</span>
                        <span class="fw-bold"><span id="cpu-usage">Loading...</span>%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="cpu-progress" style="width: 0%"></div>
                    </div>
                    <small class="text-muted"><span id="cpu-name">Loading...</span></small>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span>Memory</span>
                        <span class="fw-bold">
                            <span id="memory-used">Loading...</span> / <span id="memory-allocated">Loading...</span> MB
                        </span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-warning" id="memory-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span>Storage</span>
                        <span class="fw-bold">
                            <span id="storage-used">Loading...</span> / <span id="storage-allocated">Loading...</span> GB
                        </span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-info" id="storage-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="progress-item" style="margin-bottom: 0;">
                    <div class="progress-header">
                        <span>Network</span>
                        <span class="fw-bold">
                            <i class="bi bi-arrow-down" style="color: var(--accent-green);"></i> <span id="network-usage">Loading...</span> MB/s
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    async function fetchServerStats() {
        const response = await fetch("{{ url_for('get_server_stats') }}");
        const stats = await response.json();
        
        // Update CPU
        document.getElementById('cpu-name').textContent = stats.cpu_name;
        document.getElementById('cpu-usage').textContent = stats.cpu_usage;
        document.getElementById('cpu-progress').style.width = stats.cpu_usage + '%';
        
        // Update Memory 
        const memoryUsedMB = Math.round((stats.memory_usage / 100) * stats.memory_allocated);
        document.getElementById('memory-used').textContent = memoryUsedMB;
        document.getElementById('memory-allocated').textContent = stats.memory_allocated;
        document.getElementById('memory-progress').style.width = stats.memory_usage + '%';
        
        // Update Storage
        const storageUsedGB = Math.round((stats.storage_usage / 100) * stats.storage_allocated * 10) / 10;
        document.getElementById('storage-used').textContent = storageUsedGB;
        document.getElementById('storage-allocated').textContent = stats.storage_allocated;
        document.getElementById('storage-progress').style.width = stats.storage_usage + '%';
        
        // Update Network
        document.getElementById('network-usage').textContent = stats.network_usage;
    }
    fetchServerStats();

    function filterProcesses() {
        const query = document.getElementById('search-bar').value.toLowerCase();
        const processRows = document.querySelectorAll('[data-process-name]');
        processRows.forEach(row => {
            const processName = row.getAttribute('data-process-name').toLowerCase();
            if (processName.includes(query)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    let allProcesses = {};

    async function fetchProcesses() {
        const response = await fetch("{{ url_for('process.get_process') }}");
        allProcesses = await response.json();
        renderProcesses(Object.entries(allProcesses));
    }

    function renderProcesses(processEntries) {
        const grid = document.getElementById('process-grid');
        grid.innerHTML = '';
        processEntries.forEach(([name, process]) => {
            const row = `
            <tr data-process-name="${name}">
                <td><code>${name.substring(0, 12)}</code></td>
                <td>${name}</td>
                <td><span class="badge bg-info">${process.type}</span></td>
                <td>
                    <span class="badge ${process.status.toLowerCase() === 'running' ? 'bg-success' : 'bg-secondary'}">
                        ${process.status.charAt(0).toUpperCase() + process.status.slice(1)}
                    </span>
                </td>
                <td>
                    <a href="/process/console/${name}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> View
                    </a>
                </td>
            </tr>
            `;
            grid.innerHTML += row;
        });
        filterProcesses();
    }

    fetchProcesses();

    function sortProcesses() {
        const sortValue = document.getElementById('sort-select').value;
        let entries = Object.entries(allProcesses);

        if (sortValue === 'alpha') {
            entries.sort((a, b) => a[0].localeCompare(b[0]));
        } else if (sortValue === 'alpha-reverse') {
            entries.sort((a, b) => b[0].localeCompare(a[0]));
        } else if (sortValue === 'created') {
            entries.sort((a, b) => new Date(a[1].created_at) - new Date(b[1].created_at));
        } else if (sortValue === 'created-reverse') {
            entries.sort((a, b) => new Date(b[1].created_at) - new Date(a[1].created_at));
        }

        renderProcesses(entries);
    }
</script>
{% endblock content %}
