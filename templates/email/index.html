{% extends 'process/process_layout.html' %}

{% block process_content %}
<div class="row gap-0">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-envelope-plus"></i> Add New Email Account
            </div>
            <div class="card-body">
                <form id="create-email-form">
                    <input type="hidden" name="action" value="create">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="text" name="email" id="email" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" name="password" id="password" class="form-control" required>
                                <button type="button" class="btn btn-secondary" onclick="generatePassword()">Generate</button>
                            </div>
                        </div>
                        <div class="col-12 mb-3" id="generated-password-container" style="display: none;">
                            <label for="generated-password" class="form-label">Generated Password (click to copy)</label>
                            <input type="text" id="generated-password" class="form-control" onclick="copyGeneratedPassword()" style="cursor: pointer;" disabled>
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-success" onclick="createEmail()">
                                <i class="bi bi-plus-circle"></i> Add Account
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {% if users|length > 0 %}
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-envelope"></i> Current Email Accounts
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                            <tr>
                                <td>{{ user }}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning me-1" onclick="editPassword('{{ user }}')">
                                        <i class="bi bi-pencil"></i> Edit Password
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteEmail('{{ user }}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="card mt-3">
            <div class="card-body">
                <div class="text-center py-4">
                    <i class="bi bi-envelope display-4 text-muted"></i>
                    <p class="text-muted mt-3">No email accounts configured for this process.</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-xl-4">
        <div class="card">
            <div class="card-header bg-info">
                <i class="bi bi-info-circle"></i> Email Guide
            </div>
            <div class="card-body">
                <h6>Account Management:</h6>
                <ul class="list-unstyled small">
                    <li><i class="bi bi-envelope"></i> Emails are created in Roundcube</li>
                    <li><i class="bi bi-shield"></i> Strong passwords recommended</li>
                    <li><i class="bi bi-key"></i> Use password generator for security</li>
                    <li><i class="bi bi-pencil"></i> Passwords can be changed anytime</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-warning">
                <i class="bi bi-exclamation-triangle"></i> Security Notes
            </div>
            <div class="card-body">
                <ul class="small mb-0">
                    <li>Store passwords securely</li>
                    <li>Regular password updates recommended</li>
                    <li>Deleted accounts cannot be recovered</li>
                    <li>All actions are logged</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Editing Password -->
<div class="modal fade" tabindex="-1" id="editPasswordModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
            <div class="modal-header" style="background-color: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" style="color: var(--text-primary);">
                    <i class="bi bi-key"></i> Edit Password
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: var(--bg-secondary);">
                <form id="edit-password-form">
                    <div class="mb-3">
                        <label for="email-modal" class="form-label" style="color: var(--text-primary);">
                            <i class="bi bi-envelope"></i> Email Address
                        </label>
                        <input type="text" id="email-modal" class="form-control" 
                               style="background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary);" 
                               disabled readonly>
                    </div>
                    <div class="mb-3">
                        <label for="new-password" class="form-label" style="color: var(--text-primary);">
                            <i class="bi bi-lock"></i> New Password
                        </label>
                        <input type="password" id="new-password" class="form-control" 
                               style="background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary);" 
                               required placeholder="Enter new password">
                    </div>
                    <div class="mb-3">
                        <label for="confirm-password" class="form-label" style="color: var(--text-primary);">
                            <i class="bi bi-lock-check"></i> Confirm Password
                        </label>
                        <input type="password" id="confirm-password" class="form-control" 
                               style="background-color: var(--bg-tertiary); border-color: var(--border-color); color: var(--text-primary);" 
                               required placeholder="Confirm new password">
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="updatePassword()">
                            <i class="bi bi-check-circle"></i> Update Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal Animation */
.modal.fade .modal-dialog {
    transform: scale(0.8);
    transition: transform 0.3s ease-out;
}

.modal.show .modal-dialog {
    transform: scale(1);
}

/* Focus states for better accessibility */
.modal input:focus {
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    border-color: var(--accent-blue);
}

/* Button hover effects */
.modal .btn:hover {
    transform: translateY(-1px);
    transition: transform 0.2s ease;
}
</style>

<script>
function generatePassword() {
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+";
    let password = "";
    for (let i = 0; i < 16; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }

    document.getElementById("password").value = password;

    const container = document.getElementById("generated-password-container");
    const displayField = document.getElementById("generated-password");

    displayField.value = password;
    container.style.display = "block";
}

function copyGeneratedPassword() {
    const tempInput = document.createElement("input");
    tempInput.value = document.getElementById("generated-password").value;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);
    alert("Password copied to clipboard!");
}

function createEmail() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    if (!email || !password) {
        alert("Email and password are required.");
        return;
    }

    fetch(`/email/{{ process.name }}/create`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
    })
    .then(res => res.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
        } else if (data.error) {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(err => {
        console.error(err);
        alert("An error occurred while creating the email.");
    });
}

function editPassword(email) {
    document.getElementById('email-modal').value = email;
    new bootstrap.Modal(document.getElementById('editPasswordModal')).show();
}

function updatePassword() {
    const email = document.getElementById('email-modal').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;

    if (!newPassword || !confirmPassword) {
        alert("Both new password and confirmation are required.");
        return;
    }

    if (newPassword !== confirmPassword) {
        alert("Passwords do not match.");
        return;
    }

    fetch(`/email/{{ process.name }}/update-password`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password: newPassword })
    })
    .then(res => res.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            location.reload();
        } else if (data.error) {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(err => {
        console.error(err);
        alert("An error occurred while updating the password.");
    });
}

function deleteEmail(email) {
    if (confirm(`Are you sure you want to delete the email account: ${email}?`)) {
        fetch(`/email/{{ process.name }}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
                location.reload();
            } else if (data.error) {
                alert(`Error: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("An error occurred while deleting the email.");
        });
    }
}
</script>
{% endblock %}
